<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width initial-scale=1"
  />

  <title>Managing Data</title>

  <link
    rel="preconnect"
    href="https://fonts.googleapis.com"
  >
  <link
    rel="preconnect"
    href="https://fonts.gstatic.com"
    crossorigin
  >
  <link
    href="https://fonts.googleapis.com/css2?family=Jost:wght@100..900&display=swap"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="style.css"
  />

  <!--  DOMPurify cleans up HTML to prevent XSS attacks
  https://www.jsdelivr.com/package/npm/dompurify  -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.0/dist/purify.min.js"></script>

</head>

<body>
  <header>
    <h1>Image Uploads</h1>
  </header>
  <section id="status">
    <p id="readyStatus">‚úÖ MongoDB is Ready</p>
    <p id="notReadyStatus">‚ùå MongoDB is not connected. Please check your connection string in <code>.env</code> file.
    </p>
  </section>
  <button id="createButton">Create New Album</button>

  <dialog id="formDialog">
    <div class="modal-container">
      <div class="modal-header">
        <h2>üéµ Add an Album</h2>
        <p>Share your record with the collection</p>
      </div>

      <div class="modal-body">
        <form
          id="myForm"
          method="dialog"
        >
          <!-- Hidden field to store ID for updates -->
          <input
            type="hidden"
            name="id"
            id="id"
          />

          <!-- Hidden field to store image data -->
          <input
            type="hidden"
            name="imageUrl"
            id="imageUrl"
          />

          <!-- Image upload section -->
          <fieldset class="upload-fieldset">
            <legend>Album Cover</legend>
            <div id="uploadArea">
              <img
                id="imagePreview"
                src="assets/photo.svg"
                alt="Image preview"
              />
              <div class="upload-controls">
                <input
                  type="file"
                  id="fileInput"
                  accept="image/*"
                  style="display:none"
                />
                <button
                  type="button"
                  id="browseButton"
                >Browse</button>
                <button
                  type="button"
                  id="removeImageButton"
                  style="display:none;"
                >Remove</button>
                <p id="uploadInstructions">or drag and drop an image here</p>
              </div>
            </div>
            <div
              id="noticeArea"
              style="display:none"
            ></div>
          </fieldset>

          <fieldset>
            <label for="title">Album Title</label>
            <input
              required
              type="text"
              name="title"
              id="title"
              placeholder="e.g. Dark Side of the Moon"
              autocomplete="off"
            />
            <small class="validation">Title is required</small>
          </fieldset>

          <fieldset>
            <label for="artist">Artist</label>
            <input
              required
              type="text"
              name="artist"
              id="artist"
              placeholder="e.g. Pink Floyd"
              autocomplete="off"
            />
            <small class="validation">Artist is required</small>
          </fieldset>

          <fieldset>
            <label for="dateBought">Date Bought</label>
            <input
              type="date"
              name="dateBought"
              id="dateBought"
            />
          </fieldset>

          <fieldset>
            <label for="storeId">Store / Vendor</label>
            <input
              type="text"
              name="storeId"
              id="storeId"
              placeholder="Record Store or Vendor"
            />
          </fieldset>

          <fieldset>
            <label for="version">Version</label>
            <input
              type="text"
              name="version"
              id="version"
              placeholder="e.g. Original, Reissue, Remastered"
            />
          </fieldset>

          <fieldset>
            <label for="releaseType">Release Type</label>
            <select name="releaseType" id="releaseType">
              <option value="" disabled selected>Select a type</option>
              <option value="single">Single</option>
              <option value="ep">EP</option>
              <option value="full-length">Full Length</option>
            </select>
          </fieldset>

          <fieldset>
            <label for="format">Format</label>
            <select name="format" id="format">
              <option value="" disabled selected>Select a format</option>
              <option value="vinyl">Vinyl</option>
              <option value="cd">CD</option>
              <option value="cassette">Cassette</option>
              <option value="digital">Digital</option>
            </select>
          </fieldset>

          <fieldset>
            <label for="notes">Notes</label>
            <textarea
              placeholder="Notes about pressing, condition, or special edition"
              name="notes"
              id="notes"
              rows="5"
              cols="30"
            ></textarea>
          </fieldset>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="save"
          id="saveButton"
        >Save</button>
        <button
          type="button"
          class="cancel"
          id="cancelButton"
        >Cancel</button>
      </div>
    </div>
  </dialog>

  <main>
    <h2>üêà Noteworthy Cats</h2>
    <section id="contentArea"></section>
  </main>

  <section id="intro">
    <h3>About</h3>
    <p>Building on <a href="https://github.com/ixd-system-design/Managing-Data">prior explorations with CRUD</a>,
      this demo adds functionality for photo uploads. This application demonstrates how to handle image uploads,
      process them on the server, and store them in the cloud using <a href="https://vercel.com/docs/vercel-blob">Vercel
        Blob Storage</a>.
    </p>
    <p>The upload workflow involves several key technologies working together:
    <ol>
      <li><strong>Custom Upload UI:</strong> The default file input has been enhanced with a custom interface that
        supports both browsing and drag-and-drop functionality (on devices with a mouse).</li>
      <li><strong>BusBoy:</strong> On the backend, the <a href="https://www.npmjs.com/package/busboy">BusBoy</a>
        library parses multipart form data to handle file uploads.</li>
      <li><strong>Sharp:</strong> The <a href="https://sharp.pixelplumbing.com/">Sharp</a> library resizes uploaded
        images to a predictable size, ensuring performance and preventing system abuse.</li>
      <li><strong>Vercel Blob Storage:</strong> Processed images are stored in the cloud, generating a public URL
        which is then saved to MongoDB as a string reference.</li>
    </ol>
    </p>
    <p>
      The application maintains full CRUD functionality. When editing an item, the ID is stored in a hidden input field
      to track which record is being modified. Image URLs are also stored in a hidden field, allowing the system to
      manage both text data and image references seamlessly.
    </p>

    <h3>Learning Prompts</h3>
    <p>Can you create a system map to describe the architecture of this web app?</p>
    <p>Having added an image upload capability, what new use cases emerge?</p>
    <p>Try uploading an image: drag and drop a photo, or click Browse to select one. Notice how it gets resized and
      stored in the cloud.</p>
    <p>Explore how the form handles both text fields and file uploads together in a single submission.</p>
  </section>

  <footer>
    Created by <a href="https://nsitu.ca">Harold Sikkema</a> in the context of
    Systems Design in the Interaction Design program at Sheridan College.
  </footer>

  <script
    src="script.js"
    type="module"
  ></script>

  <script src="upload.js"></script>

</body>

</html>